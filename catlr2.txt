--- Directory Tree for: frontend-aseguradora ---
Located at: /mnt/c/Users/Luis Enrique/Desktop/Proyecto-Final/frontend-aseguradora

Info: 'tree' not found. Using built-in tree implementation.
frontend-aseguradora/
‚îú‚îÄ‚îÄ catlr2.txt
‚îú‚îÄ‚îÄ confirmar.html
‚îú‚îÄ‚îÄ dashboard.html
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ recuperar.html
‚îú‚îÄ‚îÄ restablecer.html
‚îú‚îÄ‚îÄ script.js
‚îî‚îÄ‚îÄ styles.css

--- File Contents (Recursive) for: frontend-aseguradora ---

--- confirmar.html ---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activar Cuenta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #0d6efd 0%, #0099ff 100%);
            height: 100vh; display: flex; align-items: center; justify-content: center; 
        }
        .card-confirm { width: 100%; max-width: 450px; padding: 2.5rem; border-radius: 15px; background: white; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="card-confirm text-center">
        <div id="loadingIcon" class="mb-4">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        </div>
        
        <div id="successIcon" class="mb-4 d-none">
            <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                <i class="fa-solid fa-check fa-3x"></i>
            </div>
        </div>
        <div id="errorIcon" class="mb-4 d-none">
            <div class="bg-danger text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                <i class="fa-solid fa-xmark fa-3x"></i>
            </div>
        </div>

        <h3 id="titulo" class="mb-3 fw-bold text-dark">Verificando...</h3>
        <p id="mensaje" class="text-muted mb-4">Estamos confirmando tu correo electr√≥nico, por favor espera.</p>
        
        <a href="index.html" id="btnLogin" class="btn btn-primary btn-lg w-100 fw-bold d-none">Ir al Inicio de Sesi√≥n</a>
    </div>

    <script>
        // Al cargar la p√°gina, extraemos el token y llamamos al servidor
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            if (!token) {
                mostrarError("Enlace inv√°lido o incompleto.");
                return;
            }

            try {
                // Llamada al Backend para confirmar
                const response = await fetch('http://localhost:8081/api/auth/confirm-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });

                if (response.ok) {
                    mostrarExito();
                } else {
                    const texto = await response.text();
                    mostrarError(texto || "No se pudo activar la cuenta.");
                }
            } catch (error) {
                mostrarError("Error de conexi√≥n con el servidor.");
            }
        });

        function mostrarExito() {
            document.getElementById('loadingIcon').classList.add('d-none');
            document.getElementById('successIcon').classList.remove('d-none');
            document.getElementById('titulo').textContent = "¬°Cuenta Activada!";
            document.getElementById('mensaje').textContent = "Tu correo ha sido confirmado correctamente. Ya puedes acceder a la plataforma.";
            document.getElementById('btnLogin').classList.remove('d-none');
        }

        function mostrarError(msg) {
            document.getElementById('loadingIcon').classList.add('d-none');
            document.getElementById('errorIcon').classList.remove('d-none');
            document.getElementById('titulo').textContent = "Error de Activaci√≥n";
            document.getElementById('mensaje').textContent = msg;
            document.getElementById('mensaje').classList.add('text-danger');
            
            const btn = document.getElementById('btnLogin');
            btn.classList.remove('d-none');
            btn.textContent = "Volver al Inicio";
            btn.classList.replace('btn-primary', 'btn-secondary');
        }
    </script>
</body>
</html>
--- dashboard.html ---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Aseguradora</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

    <nav class="navbar-top">
        <div class="d-flex align-items-center">
            <div class="logo-circle">A</div>
            <span class="fw-bold fs-5">Aseguradora App</span>
        </div>
        <div class="d-none d-md-block fw-bold text-uppercase">Gesti√≥n de P√≥lizas</div>
        
        <div class="d-flex align-items-center">
            <div class="bg-light rounded-pill px-3 py-1 me-3 d-flex align-items-center border">
                <i class="fa-solid fa-user-circle text-primary me-2 fs-5"></i>
                <span id="nombreUsuarioDisplay" class="small fw-bold text-dark">Usuario</span>
            </div>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm" title="Cerrar Sesi√≥n">
                <i class="fa-solid fa-power-off"></i>
            </button>
        </div>
    </nav>

    <div class="sidebar">
        <div class="text-muted small fw-bold text-uppercase mb-3 px-2">Men√∫ Principal</div>
        <nav class="nav flex-column mb-4">
            <a href="#" class="nav-link active" onclick="cargarSeccion('mis-seguros')">
                <i class="fa-solid fa-shield-halved me-2"></i> Mis Seguros
            </a>
            <a href="#" class="nav-link admin-only text-primary" onclick="cargarSeccion('anadir-seguro')">
                <i class="fa-solid fa-plus-circle me-2"></i> Contratar Seguro
            </a>
            <a href="#" class="nav-link" onclick="cargarSeccion('facturas')">
                <i class="fa-solid fa-file-invoice-dollar me-2"></i> Facturas
            </a>
            <a href="#" class="nav-link" onclick="cargarSeccion('siniestros')">
                <i class="fa-solid fa-car-crash me-2"></i> Siniestros
            </a>
            <a href="#" class="nav-link" onclick="cargarSeccion('usuarios')">
                <i class="fa-solid fa-users me-2"></i> Usuarios
            </a>
        </nav>

        <div class="text-muted small fw-bold text-uppercase mb-3 px-2">Mi Cuenta</div>
        <nav class="nav flex-column mb-4">
            <a href="#" class="nav-link" onclick="cargarSeccion('perfil')">
                <i class="fa-solid fa-id-card me-2"></i> Mi Perfil
            </a>
            <a href="#" class="nav-link" onclick="cargarSeccion('config')">
                <i class="fa-solid fa-sliders me-2"></i> Configuraci√≥n
            </a>
        </nav>

        <div class="text-muted small fw-bold text-uppercase mb-3 px-2">Soporte</div>
        <nav class="nav flex-column">
            <a href="#" class="nav-link" onclick="cargarSeccion('ayuda')">
                <i class="fa-solid fa-circle-question me-2"></i> Ayuda
            </a>
            <a href="#" class="nav-link" onclick="cargarSeccion('privacidad')">
                <i class="fa-solid fa-lock me-2"></i> Privacidad
            </a>
        </nav>
        
        <div class="mt-auto px-2 pt-4">
            <button class="btn btn-light w-100 border btn-sm text-muted" onclick="modalEmpresa.show()">
                <i class="fa-solid fa-building me-2"></i> Info Empresa
            </button>
        </div>
    </div>

    <div class="main-content">
        <div id="contenido-dinamico">
            <div class="text-center mt-5">
                <div class="spinner-border text-primary"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Aviso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <p id="modalMensaje" class="mb-0 fs-5"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <i class="fa-solid fa-trash-can text-danger fa-3x mb-3"></i>
                    <p class="fw-bold">¬øEst√°s seguro de que quieres eliminar esto?</p>
                    <p class="small text-muted">Esta acci√≥n no se puede deshacer.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarBorrado">S√≠, Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="printModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Documento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light" id="areaImpresion"></div>
                <div class="modal-footer">
                    </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="empresaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Sobre Nosotros</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p><strong>Aseguradora App S.L.</strong></p>
                    <p>Calle Principal 123, Madrid</p>
                    <p>CIF: B-12345678</p>
                    <p>Email: contacto@aseguradora.com</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCrearUsuario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">Nuevo Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCrearUsuario">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre Completo</label>
                            <input type="text" id="newUserName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Correo Electr√≥nico</label>
                            <input type="email" id="newUserEmail" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Contrase√±a</label>
                            <input type="password" id="newUserPass" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Rol</label>
                            <select id="newUserRol" class="form-select">
                                <option value="USER">Usuario (Cliente)</option>
                                <option value="ADMIN">Administrador</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success">Crear Usuario</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modal2FA" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Configurar 2FA</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div id="step1-qr">
                    <p class="mb-3">1. Escanea este QR con <strong>Google Authenticator</strong>:</p>
                    <div id="qrContainer" class="d-flex justify-content-center mb-3"></div>

                    <p class="text-muted small mt-3">2. Introduce el c√≥digo de 6 d√≠gitos que te da la app:</p>
                    <input type="text" id="inputCodeConfirm" class="form-control text-center fs-3 letter-spacing mb-3" maxlength="6" placeholder="000000">

                    <button class="btn btn-success w-100 fw-bold" onclick="confirmarActivacion2FA()">
                        <i class="fa-solid fa-check me-2"></i> Confirmar y Activar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalBorrado" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold">Zona de Peligro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <h5 class="fw-bold">¬øSeguro que quieres borrar?</h5>
                <p class="text-muted">Escribe <strong class="text-danger">ELIMINAR</strong> abajo.</p>
                
                <input type="text" id="inputBorradoConfirm" class="form-control text-center mb-3" 
                       placeholder="Escribe ELIMINAR" onkeyup="verificarTextoBorrado_V2()">
                
                <button id="btnBorrarFinal" class="btn btn-danger w-100 fw-bold" disabled onclick="ejecutarBorrado_V2()">
                    Confirmar Eliminaci√≥n
                </button>
            </div>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
--- index.html ---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Aseguradora</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0d6efd 0%, #0099ff 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        .brand-logo {
            width: 80px;
            height: 80px;
            background: #0d6efd;
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; font-weight: bold;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body>

    <div class="login-card">
        <div class="brand-logo">A</div>
        <h3 id="tituloLogin" class="text-center mb-4 fw-bold text-primary">Bienvenido</h3>
        
        <form id="loginForm">
            <div class="mb-3">
                <label for="correo" class="form-label fw-bold">Correo Electr√≥nico</label>
                <input type="email" class="form-control" id="correo" placeholder="ejemplo@correo.com" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label fw-bold">Contrase√±a</label>
                <input type="password" class="form-control" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <div class="d-grid mb-3">
                <button type="submit" class="btn btn-primary btn-lg fw-bold">Iniciar Sesi√≥n</button>
            </div>
            <div class="text-center">
                <a href="recuperar.html" class="text-decoration-none small text-muted">¬øOlvidaste tu contrase√±a?</a>
            </div>
        </form>

        <form id="form2FA" class="d-none">
            <div class="alert alert-info small text-center">
                Abre tu app <strong>Google Authenticator</strong> e introduce el c√≥digo:
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">C√≥digo (6 d√≠gitos)</label>
                <input type="text" class="form-control text-center fs-4" id="codigoInput" 
                       maxlength="6" inputmode="numeric" pattern="[0-9]*"
                       style="letter-spacing: 5px;" required>
            </div>
            <div class="d-grid mb-3">
                <button type="submit" class="btn btn-success btn-lg fw-bold">Verificar</button>
            </div>
        </form>

        <div id="errorMsg" class="alert alert-danger mt-3 d-none text-center small"></div>
    </div>

    <script>
        let correoGuardado = "";

        // --- LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const correo = document.getElementById('correo').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMsg');
            if (errorDiv) errorDiv.classList.add('d-none');

            try {
                const response = await fetch('http://localhost:8081/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ correo, password })
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data.status === '2FA_REQUIRED') {
                        // El usuario TIENE activado el 2FA, pedimos c√≥digo
                        correoGuardado = data.correo;
                        mostrarPantallaCodigo();
                    } else {
                        // El usuario NO tiene 2FA, entra directo
                        guardarSesionYRedirigir(data.usuario);
                    }
                } else {
                    mostrarError('Credenciales incorrectas.');
                }
            } catch (error) {
                console.error(error);
                mostrarError('Error de conexi√≥n.');
            }
        });

       // --- VERIFICAR C√ìDIGO ---
        document.getElementById('form2FA').addEventListener('submit', async (e) => {
            e.preventDefault();
            const codigo = document.getElementById('codigoInput').value.replace(/\s/g, '');
            const errorDiv = document.getElementById('errorMsg');
            if (errorDiv) errorDiv.classList.add('d-none');

            try {
                const response = await fetch('http://localhost:8081/api/auth/verify-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ correo: correoGuardado, codigo: codigo })
                });

                if (response.ok) {
                    const data = await response.json();
                    guardarSesionYRedirigir(data.usuario);
                } else {
                    // --- AQU√ç EST√Å EL CAMBIO PARA EL L√çMITE ---
                    if (response.status === 403) {
                        alert("Has superado el l√≠mite de 3 intentos. Volviendo al inicio de sesi√≥n...");
                        location.reload(); // Esto recarga la p√°gina y te manda al Login
                        return;
                    }

                    const textoError = await response.text();
                    mostrarError(textoError || 'C√≥digo incorrecto.');
                }
            } catch (error) {
                console.error(error);
                mostrarError('Error al verificar.');
            }
        });

        function mostrarPantallaCodigo() {
            document.getElementById('loginForm').classList.add('d-none');
            document.getElementById('form2FA').classList.remove('d-none');
            document.getElementById('tituloLogin').textContent = "Verificaci√≥n 2FA";
            document.getElementById('codigoInput').focus();
        }

        function guardarSesionYRedirigir(usuario) {
            if (!usuario.idUsuario && usuario.id) usuario.idUsuario = usuario.id;
            sessionStorage.setItem('usuario', JSON.stringify(usuario));
            window.location.href = 'dashboard.html';
        }

        function mostrarError(msg) {
            const d = document.getElementById('errorMsg');
            if(d) { d.textContent = msg; d.classList.remove('d-none'); }
            else alert(msg);
        }
    </script>
</body>
</html>
--- recuperar.html ---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contrase√±a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #f0f2f5 0%, #e1e4e8 100%);
            height: 100vh; display: flex; align-items: center; justify-content: center; 
        }
        .card-rec { width: 100%; max-width: 400px; padding: 2rem; border-radius: 15px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="card-rec text-center">
        <div class="mb-4">
            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                <i class="fa-solid fa-envelope-open-text fa-2x"></i>
            </div>
        </div>
        <h3 class="mb-2 text-dark fw-bold">¬øOlvidaste tu contrase√±a?</h3>
        <p class="text-muted mb-4 small">Introduce tu correo y te enviaremos un enlace para restablecerla.</p>
        
        <form id="formRecuperar">
            <div class="mb-3 text-start">
                <label class="form-label fw-bold small">Correo Electr√≥nico</label>
                <input type="email" class="form-control" id="emailRec" required placeholder="ej: admin@test.com">
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary fw-bold">Enviar Enlace</button>
                <a href="index.html" class="btn btn-light text-muted">Volver al Login</a>
            </div>
        </form>

        <div id="mensaje" class="alert mt-3 d-none text-start small"></div>
    </div>

    <script>
        document.getElementById('formRecuperar').addEventListener('submit', async (e) => {
            e.preventDefault();
            const correo = document.getElementById('emailRec').value;
            const btn = e.target.querySelector('button');
            const msgDiv = document.getElementById('mensaje');

            btn.disabled = true;
            btn.textContent = "Enviando...";
            msgDiv.classList.add('d-none');

            try {
                // Llamamos al backend para que env√≠e el email
                const response = await fetch('http://localhost:8081/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ correo: correo })
                });

                // Mostramos mensaje de √©xito
                msgDiv.textContent = "Si el correo es correcto, recibir√°s un enlace en breve.";
                msgDiv.className = 'alert alert-success mt-3 text-start small';
                msgDiv.classList.remove('d-none');
                
            } catch (error) {
                msgDiv.textContent = "Error de conexi√≥n.";
                msgDiv.className = 'alert alert-danger mt-3 text-start small';
                msgDiv.classList.remove('d-none');
            } finally {
                btn.disabled = false;
                btn.textContent = "Enviar Enlace";
            }
        });
    </script>
</body>
</html>
--- restablecer.html ---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Contrase√±a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #f0f2f5 0%, #e1e4e8 100%);
            height: 100vh; display: flex; align-items: center; justify-content: center; 
        }
        .card-rec { width: 100%; max-width: 400px; padding: 2rem; border-radius: 15px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="card-rec text-center">
        <div class="mb-4">
            <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                <i class="fa-solid fa-key fa-2x"></i>
            </div>
        </div>
        <h3 class="mb-2 text-dark fw-bold">Nueva Contrase√±a</h3>
        <p class="text-muted mb-4 small">Por seguridad, introduce tu nueva clave dos veces.</p>
        
        <form id="formRestablecer">
            <div class="mb-3 text-start">
                <label class="form-label fw-bold small">Nueva Contrase√±a</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="newPass" required placeholder="M√≠nimo 4 caracteres">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePass('newPass', 'icon1')">
                        <i class="fa-solid fa-eye" id="icon1"></i>
                    </button>
                </div>
            </div>

            <div class="mb-4 text-start">
                <label class="form-label fw-bold small">Repite la Contrase√±a</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="confirmPass" required placeholder="Vuelve a escribirla">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePass('confirmPass', 'icon2')">
                        <i class="fa-solid fa-eye" id="icon2"></i>
                    </button>
                </div>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary fw-bold">Guardar y Acceder</button>
            </div>
        </form>

        <div id="mensaje" class="alert mt-3 d-none text-start small"></div>
    </div>

    <script>
        // 1. EXTRAER EL TOKEN DE LA URL
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        if (!token) {
            document.body.innerHTML = '<div class="alert alert-danger m-5">Error: Enlace inv√°lido o incompleto.</div>';
        }

        // 2. ENVIAR NUEVA CONTRASE√ëA
        document.getElementById('formRestablecer').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const pass1 = document.getElementById('newPass').value;
            const pass2 = document.getElementById('confirmPass').value;
            const btn = e.target.querySelector('button[type="submit"]');
            const msgDiv = document.getElementById('mensaje');

            // --- VALIDACI√ìN: ¬øCOINCIDEN? ---
            if (pass1 !== pass2) {
                msgDiv.textContent = "Error: Las contrase√±as no coinciden.";
                msgDiv.className = 'alert alert-danger mt-3 text-start small';
                msgDiv.classList.remove('d-none');
                return; // Cortamos aqu√≠, no enviamos nada al servidor
            }

            // Si coinciden, seguimos...
            btn.disabled = true;
            btn.textContent = "Guardando...";
            msgDiv.classList.add('d-none');

            try {
                const response = await fetch('http://localhost:8081/api/auth/reset-password-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, nuevaPassword: pass1 })
                });

                if (response.ok) {
                    msgDiv.textContent = "¬°Contrase√±a actualizada! Redirigiendo al login...";
                    msgDiv.className = 'alert alert-success mt-3 text-start small';
                    msgDiv.classList.remove('d-none');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    const texto = await response.text();
                    msgDiv.textContent = "Error: " + texto;
                    msgDiv.className = 'alert alert-danger mt-3 text-start small';
                    msgDiv.classList.remove('d-none');
                    btn.disabled = false;
                    btn.textContent = "Intentar de nuevo";
                }
            } catch (error) {
                console.error(error);
                msgDiv.textContent = "Error de conexi√≥n.";
                msgDiv.className = 'alert alert-danger mt-3 text-start small';
                msgDiv.classList.remove('d-none');
                btn.disabled = false;
                btn.textContent = "Guardar y Acceder";
            }
        });

        // Funci√≥n reutilizable para ver/ocultar contrase√±a
        function togglePass(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.replace("fa-eye", "fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.replace("fa-eye-slash", "fa-eye");
            }
        }
    </script>
</body>
</html>
--- script.js ---
// =========================================================
// 1. CONFIGURACI√ìN Y VARIABLES GLOBALES
// =========================================================
const API_URL = 'http://localhost:8081/api';
const usuarioGuardado = sessionStorage.getItem('usuario');
let usuario = null;

// Variables para los Modales (Popups)
let modalInfo, modalConfirm, modalEmpresa, modalPrint, modalCrearUser;
let itemABorrar = { tipo: '', id: 0 };

// =========================================================
// 2. INICIALIZACI√ìN
// =========================================================
if (!usuarioGuardado) {
    window.location.href = 'index.html';
} else {
    usuario = JSON.parse(usuarioGuardado);
    document.addEventListener('DOMContentLoaded', () => {
        // Poner nombre en el men√∫ superior
        const nombreDisplay = document.getElementById('nombreUsuarioDisplay');
        if(nombreDisplay) nombreDisplay.textContent = usuario.nombreCompleto;
        
        // --- GESTI√ìN DE ROLES: OCULTAR ELEMENTOS SOLO-ADMIN ---
        if (usuario.rol !== 'ADMIN') {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'none'; 
                el.innerHTML = ''; // Vaciar contenido por seguridad
            });
        }

        // Inicializar Modales de Bootstrap
        modalInfo = new bootstrap.Modal(document.getElementById('infoModal'));
        modalConfirm = new bootstrap.Modal(document.getElementById('confirmModal'));
        modalPrint = new bootstrap.Modal(document.getElementById('printModal'));
        
        // Inicializar modal de empresa si existe (aunque ahora estar√° en el footer)
        const elModalEmpresa = document.getElementById('empresaModal');
        if (elModalEmpresa) modalEmpresa = new bootstrap.Modal(elModalEmpresa);
        
        // Inicializar modal de crear usuario
        const elModalUser = document.getElementById('modalCrearUsuario');
        if(elModalUser) modalCrearUser = new bootstrap.Modal(elModalUser);

        
        // Listener formulario crear usuario
        const formUser = document.getElementById('formCrearUsuario');
        if(formUser) {
            formUser.addEventListener('submit', crearUsuarioNuevo);
        }

        // Cargar la primera secci√≥n por defecto
        cargarSeccion('mis-seguros');
    });
}

// =========================================================
// 3. NAVEGACI√ìN CENTRAL (ROUTER)
// =========================================================
async function cargarSeccion(seccion) {
    const contenedor = document.getElementById('contenido-dinamico');
    // Quitar clase 'active' de todos los links
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

    // --- SECCI√ìN: MIS SEGUROS (L√≥gica Centralizada) ---
    if (seccion === 'mis-seguros') {
        const titulo = usuario.rol === 'ADMIN' ? 'Gesti√≥n Global de P√≥lizas' : 'Mis P√≥lizas Contratadas';
        renderizarCargando(contenedor, 'Cargando p√≥lizas...');
        try {
            // LOGICA CAMBIADA:
            // Admin -> Pide TODOS los seguros (/api/seguros)
            // User -> Pide SUS seguros (/api/seguros/usuario/ID)
            let endpoint = '';
            if (usuario.rol === 'ADMIN') {
                endpoint = `${API_URL}/seguros`; // Asumiendo que has creado este endpoint global en Java
            } else {
                endpoint = `${API_URL}/seguros/usuario/${usuario.idUsuario}`;
            }

            const res = await fetch(endpoint, { credentials: 'include' });
            
            // Si falla el endpoint global (404), fallback al del usuario para que no rompa
            if (!res.ok && usuario.rol === 'ADMIN') {
                const resB = await fetch(`${API_URL}/seguros/usuario/${usuario.idUsuario}`, { credentials: 'include' });
                const segurosB = await resB.json();
                renderizarSeguros(segurosB, contenedor, titulo);
            } else if (res.ok) {
                const seguros = await res.json();
                renderizarSeguros(seguros, contenedor, titulo);
            } else {
                throw new Error("Error al cargar seguros");
            }
        } catch (e) { mostrarError(contenedor); }

 // --- SECCI√ìN: FACTURAS ---
    } else if (seccion === 'facturas') {
        const titulo = usuario.rol === 'ADMIN' ? 'Control de Facturaci√≥n Global' : 'Mis Facturas';
        renderizarCargando(contenedor, 'Cargando facturas...');
        
        try {
            // L√ìGICA INTELIGENTE:
            // Si es ADMIN -> Trae TODAS (/api/facturas)
            // Si es USER  -> Trae SOLO LAS SUYAS (/api/facturas/usuario/ID)
            const endpoint = usuario.rol === 'ADMIN' 
                ? `${API_URL}/facturas` 
                : `${API_URL}/facturas/usuario/${usuario.idUsuario}`;

            const res = await fetch(endpoint, { credentials: 'include' });
            
            if (res.ok) {
                const facturas = await res.json();
                renderizarFacturas(facturas, contenedor, titulo);
            } else {
                mostrarError(contenedor);
            }
        } catch (e) { mostrarError(contenedor); }

  // --- SECCI√ìN: SINIESTROS ---
    } else if (seccion === 'siniestros') {
        const titulo = usuario.rol === 'ADMIN' ? 'Gesti√≥n de Siniestros (Todos)' : 'Mis Siniestros';
        renderizarCargando(contenedor, 'Cargando siniestros...');
        
        try {
            // 1. Obtener la lista de siniestros (Todos o M√≠os)
            const endpointSin = usuario.rol === 'ADMIN' 
                ? `${API_URL}/siniestros` 
                : `${API_URL}/siniestros/usuario/${usuario.idUsuario}`;
            
            const resSin = await fetch(endpointSin, { credentials: 'include' });
            const listaSiniestros = await resSin.json();
            
            // 2. Obtener lista de seguros (necesario para el desplegable de "Nuevo Siniestro")
            // (El Admin necesita ver TODOS los seguros para poder abrir partes en nombre de otros si quisiera, 
            // o al menos sus propios seguros para pruebas).
            const endpointSeg = usuario.rol === 'ADMIN' 
                ? `${API_URL}/seguros`
                : `${API_URL}/seguros/usuario/${usuario.idUsuario}`;

            const resSeg = await fetch(endpointSeg, { credentials: 'include' });
            const listaSeguros = await resSeg.json();

            renderizarSiniestros(listaSiniestros, listaSeguros, contenedor, titulo);

        } catch (e) { mostrarError(contenedor); }

    // --- SECCI√ìN: USUARIOS (NUEVA) ---
    } else if (seccion === 'usuarios') {
        renderizarCargando(contenedor, 'Cargando directorio de usuarios...');
        try {
            const res = await fetch(`${API_URL}/usuarios`, { credentials: 'include' });
            if(res.ok) {
                const lista = await res.json();
                renderizarUsuarios(lista, contenedor);
            } else {
                contenedor.innerHTML = '<div class="alert alert-warning">No se pudo cargar la lista de usuarios.</div>';
            }
        } catch (e) { mostrarError(contenedor); }

    // --- SECCI√ìN: A√ëADIR SEGURO (SOLO ADMIN) ---
    } else if (seccion === 'anadir-seguro') {
        renderizarCargando(contenedor, 'Cargando datos del formulario...');
        try {
            // 1. Cargar tipos de seguro
            const resTipos = await fetch(`${API_URL}/tipos-seguro`, { credentials: 'include' });
            const tipos = await resTipos.json();

            // 2. Cargar lista de usuarios (Para asignar el seguro)
            const resUsers = await fetch(`${API_URL}/usuarios`, { credentials: 'include' });
            const usuariosLista = await resUsers.json();

            renderizarFormularioAlta(tipos, usuariosLista, contenedor);
        } catch (e) { mostrarError(contenedor); }
    
    // --- SECCIONES EST√ÅNDAR (RESTAURADAS) ---
    } else if (seccion === 'perfil') {
        renderizarPerfil(contenedor);

    } else if (seccion === 'ayuda') {
        renderizarAyuda(contenedor);

    } else if (seccion === 'config') {
        renderizarConfiguracion(contenedor);

    } else if (seccion === 'privacidad') {
        renderizarPrivacidad(contenedor);
    }
}

// =========================================================
// 4. RENDERIZADORES (VISTAS)
// =========================================================

// --- VISTA SEGUROS (ADAPTADA ADMIN/USER) ---
function renderizarSeguros(lista, contenedor, titulo) {
    if (lista.length === 0) { 
        contenedor.innerHTML = `<h3 class="mb-4">${titulo}</h3><div class="alert alert-info shadow-sm">No hay p√≥lizas registradas.</div>`; 
        return; 
    }
    
    let html = `<h3 class="mb-4">${titulo}</h3><div class="row">`;
    lista.forEach(seguro => {
        let icono = 'üõ°Ô∏è';
        // Protecci√≥n contra null en tipoSeguro
        const nombreTipo = seguro.tipoSeguro ? seguro.tipoSeguro.nombre : 'P√≥liza Gen√©rica';
        const n = nombreTipo.toLowerCase();
        
        if(n.includes('coche')) icono = 'üöó';
        else if(n.includes('moto')) icono = 'üèçÔ∏è';
        else if(n.includes('hogar')) icono = 'üè†';
        else if(n.includes('vida') || n.includes('salud')) icono = '‚ù§Ô∏è';

        // L√ìGICA DE VISUALIZACI√ìN SEG√öN ROL
        let extraInfo = '';
        let botonBorrar = '';

        if (usuario.rol === 'ADMIN') {
            // El Admin ve qui√©n es el due√±o y bot√≥n de borrar
            const clienteNombre = seguro.usuario ? seguro.usuario.nombreCompleto : 'Sin Asignar';
            const clienteEmail = seguro.usuario ? seguro.usuario.correo : '';
            
            extraInfo = `
            <div class="mt-2 pt-2 border-top small text-muted bg-light p-2 rounded">
                <i class="fa-solid fa-user me-1"></i> <strong>Cliente:</strong> ${clienteNombre}<br>
                <i class="fa-solid fa-envelope me-1"></i> ${clienteEmail}
            </div>`;

            botonBorrar = `
            <button class="btn btn-outline-danger btn-sm" onclick="solicitarBorrado('seguros', ${seguro.idSeguro})">
                <i class="fa-solid fa-trash"></i> Eliminar
            </button>`;
        }

        html += `
        <div class="col-md-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0 text-primary">${icono} ${nombreTipo}</h5>
                        <span class="badge bg-success">ACTIVO</span>
                    </div>
                    <p class="text-muted small"><strong>P√ìLIZA:</strong> ${seguro.numPoliza}</p>
                    <p class="bg-light p-2 rounded small border">${seguro.datosEspecificos}</p>
                    
                    ${extraInfo} <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                        <span class="fw-bold fs-5">${seguro.primaAnual} ‚Ç¨/a√±o</span>
                        ${botonBorrar} </div>
                </div>
            </div>
        </div>`;
    });
    html += '</div>';
    contenedor.innerHTML = html;
}

// --- VISTA USUARIOS (NUEVA) ---
function renderizarUsuarios(lista, contenedor) {
    let botonCrear = '';
    let headerAcciones = '';
    
    // Solo Admin puede crear
    if (usuario.rol === 'ADMIN') {
        botonCrear = `
        <div class="mb-3 text-end">
            <button class="btn btn-success shadow-sm" onclick="modalCrearUser.show()">
                <i class="fa-solid fa-user-plus me-2"></i> Nuevo Usuario
            </button>
        </div>`;
        headerAcciones = '<th class="text-end pe-4">Acciones</th>';
    }

    let html = `
    <h3 class="mb-4">Directorio de Usuarios</h3>
    ${botonCrear}
    <div class="card border-0 shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Nombre Completo</th>
                        <th>Correo Electr√≥nico</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        ${headerAcciones}
                    </tr>
                </thead>
                <tbody>`;

    lista.forEach(u => {
        let badgeRol = u.rol === 'ADMIN' ? 'bg-danger' : 'bg-primary';
        let badgeEstado = u.activo ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-secondary">Inactivo</span>';
        
        let colAcciones = '';
        if (usuario.rol === 'ADMIN') {
            // Admin no se borra a s√≠ mismo
            if (u.idUsuario !== usuario.idUsuario) {
                colAcciones = `
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-outline-danger" onclick="solicitarBorrado('usuarios', ${u.idUsuario})" title="Eliminar Usuario">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>`;
            } else {
                colAcciones = '<td class="text-end pe-4"><span class="text-muted small fst-italic">Tu cuenta</span></td>';
            }
        }

        html += `
        <tr>
            <td class="ps-4 fw-bold">${u.nombreCompleto}</td>
            <td>${u.correo}</td>
            <td><span class="badge ${badgeRol}">${u.rol}</span></td>
            <td>${badgeEstado}</td>
            ${colAcciones}
        </tr>`;
    });

    html += '</tbody></table></div></div>';
    contenedor.innerHTML = html;
}

// --- VISTA FACTURAS (VERSI√ìN FINAL) ---
function renderizarFacturas(lista, contenedor, titulo) {
    const tituloMostrar = titulo || 'Mis Facturas';
    
    if (!lista || lista.length === 0) { 
        contenedor.innerHTML = `<h3 class="mb-4">${tituloMostrar}</h3><div class="alert alert-info shadow-sm">No hay facturas disponibles.</div>`;
        return; 
    }
    
    const thCliente = usuario.rol === 'ADMIN' ? '<th class="ps-3">Cliente</th>' : '';

    let html = `
    <h3 class="mb-4">${tituloMostrar}</h3>
    <div class="card border-0 shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Concepto</th>
                        ${thCliente} 
                        <th>Fecha</th>
                        <th>Importe</th>
                        <th class="text-end pe-4">Acciones</th>
                    </tr>
                </thead>
                <tbody>`;
    
    lista.forEach(f => {
        // EXTRACCI√ìN DIRECTA DEL ID
        // Usamos idFactura porque es el que viene en tu base de datos
        const elId = f.idFactura; 
        
        const jsonF = JSON.stringify(f).replace(/"/g, '&quot;');
        
        let tdCliente = '';
        if (usuario.rol === 'ADMIN') {
            const nombre = (f.usuario && f.usuario.nombreCompleto) ? f.usuario.nombreCompleto : 'Desconocido';
            const email = (f.usuario && f.usuario.correo) ? f.usuario.correo : '-';
            tdCliente = `<td class="ps-3"><small class="fw-bold">${nombre}</small><br><small class="text-muted">${email}</small></td>`;
        }

        // Dentro de renderizarFacturas...
        let btnBorrar = '';
        if (usuario.rol === 'ADMIN') {
        // CAMBIO: Llamamos a solicitarBorrado_V2
         btnBorrar = `<button class="btn btn-sm btn-outline-danger ms-1" onclick="solicitarBorrado_V2('facturas', ${idReal})" title="Eliminar"><i class="fa-solid fa-trash"></i></button>`;
}

        html += `
        <tr>
            <td class="ps-4 fw-bold">${f.concepto}</td>
            ${tdCliente}
            <td>${f.fechaEmision}</td>
            <td class="fw-bold text-primary">${f.importe} ‚Ç¨</td>
            <td class="text-end pe-4">
                <button class="btn btn-sm btn-primary" onclick="prepararFactura(${jsonF})" title="Imprimir"><i class="fa-solid fa-print"></i></button>
                ${btnBorrar}
            </td>
        </tr>`;
    });
    html += '</tbody></table></div></div>';
    contenedor.innerHTML = html;
}

// --- VISTA SINIESTROS (MEJORADA) ---
function renderizarSiniestros(siniestros, seguros, contenedor, titulo) {
    const tituloMostrar = titulo || 'Gesti√≥n de Siniestros';
    
    // Preparar el desplegable para nuevo siniestro
    let opcionesSeguro = '<option value="" disabled selected>-- Seleccione Seguro --</option>';
    if (seguros.length > 0) {
        seguros.forEach(s => {
            // Si es Admin, mostramos tambi√©n el due√±o del seguro en el desplegable
            const extra = usuario.rol === 'ADMIN' && s.usuario ? ` (${s.usuario.nombreCompleto})` : '';
            opcionesSeguro += `<option value="${s.idSeguro}">${s.tipoSeguro.nombre} - ${s.numPoliza}${extra}</option>`;
        });
    } else {
        opcionesSeguro = '<option disabled>No hay seguros disponibles</option>';
    }

    let listaHTML = '';
    if (siniestros.length === 0) {
        listaHTML = '<div class="alert alert-success">No hay siniestros registrados.</div>';
    } else {
        siniestros.forEach(s => {
            let color = s.estado === 'ABIERTO' ? 'warning' : 'success';
            
           
          // Dentro de renderizarSiniestros...
            let btnBorrar = '';
            if (usuario.rol === 'ADMIN') {
           // CAMBIO: Llamamos a solicitarBorrado_V2
          btnBorrar = `<button class="btn btn-sm btn-outline-danger ms-1" onclick="solicitarBorrado_V2('siniestros', ${idReal})" title="Eliminar"><i class="fa-solid fa-trash"></i></button>`;
}

            listaHTML += `
            <div class="card mb-3 border-${color} border-start border-3 shadow-sm">
                <div class="card-body">
                    ${infoCliente}
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-0">P√≥liza: ${s.seguro ? s.seguro.numPoliza : '???'}</h6>
                            <span class="badge bg-${color} mt-1">${s.estado}</span>
                        </div>
                        ${btnBorrar}
                    </div>
                    <hr class="my-2">
                    <p class="mb-1 small text-muted"><i class="fa-solid fa-calendar-day me-1"></i> ${s.fechaSuceso}</p>
                    <p class="mb-2 text-dark">${s.descripcion}</p>
                    <div class="bg-light p-2 rounded small fst-italic border"><i class="fa-solid fa-user-shield me-1"></i> Resoluci√≥n: ${s.resolucion}</div>
                </div>
            </div>`;
        });
    }

    contenedor.innerHTML = `
    <h3 class="mb-4">${tituloMostrar}</h3>
    <div class="row">
        <div class="col-md-5 mb-4">
            <div class="card shadow border-0">
                <div class="card-header bg-danger text-white fw-bold"><i class="fa-solid fa-triangle-exclamation me-2"></i> Reportar Nuevo Siniestro</div>
                <div class="card-body">
                    <form id="formSiniestro">
                        <div class="mb-3">
                            <label class="fw-bold">P√≥liza Afectada</label>
                            <select id="sinSeguro" class="form-select" required>${opcionesSeguro}</select>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Descripci√≥n del incidente</label>
                            <textarea id="sinDesc" class="form-control" rows="4" required placeholder="Describe detalladamente qu√© ha ocurrido..."></textarea>
                        </div>
                        <div class="d-grid"><button type="submit" class="btn btn-danger">Enviar Parte</button></div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <h5 class="text-muted mb-3">Historial de Incidencias</h5>
            <div style="max-height: 600px; overflow-y: auto; padding-right: 5px;">
                ${listaHTML}
            </div>
        </div>
    </div>`;

    // Re-activar el listener del formulario
    document.getElementById('formSiniestro').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/siniestros`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ 
                    descripcion: document.getElementById('sinDesc').value, 
                    seguro: { idSeguro: document.getElementById('sinSeguro').value } 
                })
            });
            if (res.ok) { 
                mostrarPopup("Siniestro reportado correctamente."); 
                cargarSeccion('siniestros'); // Recargar para ver el nuevo
            }
            else mostrarPopup("Error al reportar.");
        } catch (error) { mostrarPopup("Error conexi√≥n."); }
    });
}

// --- VISTA FORMULARIO ALTA SEGURO (MODIFICADO PARA ADMIN) ---
function renderizarFormularioAlta(tipos, listaUsuarios, contenedor) {
    let optsTipos = `<option value="" disabled selected>-- Seleccione Tipo --</option>`;
    tipos.forEach(t => optsTipos += `<option value="${t.idTipo}">${t.nombre} (${t.precioBase}‚Ç¨)</option>`);

    // Selector de Usuarios (Solo lo usa el Admin)
    let optsUsuarios = `<option value="" disabled selected>-- Seleccione Cliente --</option>`;
    listaUsuarios.forEach(u => {
        const rol = u.rol === 'ADMIN' ? '(Admin)' : '(Cliente)';
        optsUsuarios += `<option value="${u.idUsuario}">${u.nombreCompleto} - ${u.correo} ${rol}</option>`;
    });

    const poliza = 'POL-' + Math.floor(Math.random()*99999);
    
    contenedor.innerHTML = `
    <h3 class="mb-4">Contratar Nuevo Seguro (Administraci√≥n)</h3>
    <div class="alert alert-primary small"><i class="fa-solid fa-info-circle me-2"></i> Como administrador, est√°s creando una p√≥liza en nombre de un cliente.</div>
    
    <div class="card shadow-sm border-0" style="max-width: 700px;"><div class="card-body p-4">
    <form id="formAlta">
        <div class="mb-3">
            <label class="fw-bold text-primary">Asignar a Cliente</label>
            <select id="idClienteAsignado" class="form-select border-primary" required>
                ${optsUsuarios}
            </select>
        </div>

        <div class="row mb-3">
            <div class="col"><label class="fw-bold">Tipo</label><select id="idTipo" class="form-select" required>${optsTipos}</select></div>
            <div class="col"><label class="fw-bold">P√≥liza</label><input id="numPoliza" class="form-control bg-light" value="${poliza}" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col"><label>Inicio</label><input type="date" id="fInicio" class="form-control" required></div>
            <div class="col"><label>Renovaci√≥n</label><input type="date" id="fRenov" class="form-control" required></div>
        </div>
        <div class="mb-3"><label class="fw-bold">Detalles</label><textarea id="detalles" class="form-control" required></textarea></div>
        <div class="mb-3"><label class="fw-bold">Precio (‚Ç¨)</label><input type="number" id="precio" class="form-control" required></div>
        
        <button type="submit" class="btn btn-primary w-100">Crear y Asignar P√≥liza</button>
    </form></div></div>`;
    
    const iIni = document.getElementById('fInicio');
    const iRen = document.getElementById('fRenov');
    if(iIni && iRen) {
        iIni.addEventListener('change', () => {
            if (iIni.value) {
                const d = new Date(iIni.value); d.setFullYear(d.getFullYear() + 1);
                iRen.value = d.toISOString().split('T')[0];
            }
        });
    }

    document.getElementById('formAlta').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Obtenemos el ID del usuario seleccionado en el Select
        const idCliente = document.getElementById('idClienteAsignado').value;

        const d = { 
            numPoliza: document.getElementById('numPoliza').value, 
            fechaInicio: document.getElementById('fInicio').value, 
            fechaRenovacion: document.getElementById('fRenov').value, 
            primaAnual: parseFloat(document.getElementById('precio').value), 
            datosEspecificos: document.getElementById('detalles').value, 
            estado: "ACTIVO", 
            usuario: { idUsuario: idCliente }, // ASIGNACI√ìN AL CLIENTE SELECCIONADO
            tipoSeguro: { idTipo: document.getElementById('idTipo').value } 
        };
        try { 
            const r = await fetch(`${API_URL}/seguros`, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                credentials: 'include',
                body:JSON.stringify(d)
            }); 
            if(r.ok){ mostrarPopup("¬°P√≥liza creada y asignada!"); cargarSeccion('mis-seguros'); } else mostrarPopup("Error al guardar."); 
        } catch(e){ mostrarPopup("Error conexi√≥n."); }
    });
}

// --- VISTA CONFIGURACI√ìN (RESTAURADA COMPLETA) ---
function renderizarConfiguracion(contenedor) {
    // A. Si est√° ACTIVADO: Mostramos bot√≥n rojo para quitarlo
    if (usuario.twoFactorEnabled) {
        botonHtml = `
            <div class="alert alert-success mb-3">
                <i class="fa-solid fa-check-circle me-2"></i> Tu cuenta est√° protegida con doble factor.
            </div>
            <button class="btn btn-outline-danger w-100 shadow-sm" onclick="desactivar2FA()">
                <i class="fa-solid fa-user-shield me-2"></i> Desactivar 2FA
            </button>`;
        estadoBadge = '<span class="badge bg-success fs-6 px-3 py-2">ACTIVADO</span>';
    } 
    // B. Si est√° DESACTIVADO: Mostramos bot√≥n azul para ponerlo
    else {
        botonHtml = `
            <button class="btn btn-primary btn-lg w-100 mt-3 shadow-sm" onclick="iniciarSetup2FA()">
                <i class="fa-solid fa-qrcode me-2"></i> Configurar y Activar 2FA
            </button>`;
        estadoBadge = '<span class="badge bg-secondary fs-6 px-3 py-2">DESACTIVADO</span>';
    }

    // Renderizamos la tarjeta
    contenedor.innerHTML = `
    <h3 class="mb-4">Configuraci√≥n de Cuenta</h3>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow border-0">
                <div class="card-header bg-white p-3 border-bottom">
                    <h5 class="fw-bold text-primary mb-0"><i class="fa-solid fa-shield-halved me-2"></i> Seguridad Avanzada</h5>
                </div>
                <div class="card-body p-5 text-center">
                    <i class="fa-solid fa-mobile-screen-button text-primary fa-4x mb-4"></i>
                    <h4 class="fw-bold mb-3">Autenticaci√≥n en Dos Pasos (2FA)</h4>
                    <p class="text-muted mb-4">
                        Protege el inicio de sesi√≥n solicitando un c√≥digo adicional desde tu m√≥vil.
                    </p>
                    
                    <div class="d-inline-block bg-light p-3 rounded border mb-3">
                        <strong>Estado actual:</strong> ${estadoBadge}
                    </div>

                    <div class="mt-2">
                        ${botonHtml}
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}
// --- VISTA PERFIL (RESTAURADA COMPLETA) ---
function renderizarPerfil(c) {
    c.innerHTML = `<h3 class="mb-4">Mi Perfil</h3><div class="card shadow-sm border-0" style="max-width:600px;"><div class="card-body p-4"><form id="formPerfil">
    <div class="mb-3"><label class="fw-bold">Nombre</label><input type="text" id="pN" class="form-control" value="${usuario.nombreCompleto}"></div>
    <div class="mb-3"><label class="fw-bold">Email</label><input type="text" class="form-control bg-light" value="${usuario.correo}" disabled></div>
    <div class="mb-3"><label class="fw-bold">M√≥vil</label><input type="text" id="pM" class="form-control" value="${usuario.movil||''}"></div>
    <button type="submit" class="btn btn-primary w-100">Guardar Cambios</button>
    </form></div></div>`;
    
    document.getElementById('formPerfil').addEventListener('submit', async(e)=>{
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/usuarios/${usuario.idUsuario}`, { 
                method:'PUT', 
                headers:{'Content-Type':'application/json'}, 
                credentials: 'include',
                body:JSON.stringify({...usuario, nombreCompleto:document.getElementById('pN').value, movil:document.getElementById('pM').value})
            });
            if(res.ok){ 
                usuario=await res.json(); 
                sessionStorage.setItem('usuario',JSON.stringify(usuario)); 
                document.getElementById('nombreUsuarioDisplay').textContent=usuario.nombreCompleto; 
                mostrarPopup("Perfil actualizado."); 
            }
        } catch(e){mostrarPopup("Error.");}
    });
}

// --- VISTA AYUDA (RESTAURADA COMPLETA) ---
function renderizarAyuda(contenedor) {
    contenedor.innerHTML = `
    <h3 class="mb-4">Centro de Ayuda y Soporte</h3>
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-3">Env√≠anos tu consulta</h5>
                    <form id="formAyuda">
                        <div class="mb-3">
                            <label class="form-label">Asunto</label>
                            <select class="form-select" required><option>Duda P√≥liza</option><option>Problema Factura</option><option>Otro</option></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mensaje</label>
                            <textarea class="form-control" rows="4" required placeholder="Describe tu consulta..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Enviar</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card bg-light border-0 h-100">
                <div class="card-body">
                    <h5><i class="fa-solid fa-circle-question me-2"></i>Preguntas Frecuentes</h5>
                    <div class="accordion mt-3" id="faqAcc">
                        <div class="accordion-item mb-2 border-0 shadow-sm">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#q1">No puedo borrar un seguro</button></h2>
                            <div id="q1" class="accordion-collapse collapse" data-bs-parent="#faqAcc">
                                <div class="accordion-body text-muted small">Debes cancelar primero la factura asociada antes de eliminar el seguro, por motivos de seguridad fiscal.</div>
                            </div>
                        </div>
                        <div class="accordion-item mb-2 border-0 shadow-sm">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#q2">¬øC√≥mo descargar facturas?</button></h2>
                            <div id="q2" class="accordion-collapse collapse" data-bs-parent="#faqAcc">
                                <div class="accordion-body text-muted small">Ve a la secci√≥n Facturas y pulsa el bot√≥n azul.</div>
                            </div>
                        </div>
                        <div class="accordion-item mb-2 border-0 shadow-sm">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#q3">¬øD√≥nde veo la informaci√≥n de la empresa?</button></h2>
                            <div id="q3" class="accordion-collapse collapse" data-bs-parent="#faqAcc">
                                <div class="accordion-body text-muted small">Haz clic en el bot√≥n 'Info Empresa' en el men√∫ lateral.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
    document.getElementById('formAyuda').addEventListener('submit', (e) => {
        e.preventDefault();
        mostrarPopup("Mensaje enviado. Contactaremos contigo pronto.");
        e.target.reset();
    });
}

// --- VISTA PRIVACIDAD (RESTAURADA COMPLETA) ---
function renderizarPrivacidad(contenedor) {
    const year = new Date().getFullYear();
    contenedor.innerHTML = `
    <h3 class="mb-4">Pol√≠tica de Privacidad y Aviso Legal</h3>
    <div class="card shadow-sm border-0">
        <div class="card-body p-5">
            <div class="text-center mb-5">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; font-weight: bold; font-size: 24px;">A</div>
                <h2 class="fw-bold text-dark">Aseguradora App</h2>
                <p class="text-muted">Comprometidos con la transparencia y tu seguridad.</p>
            </div>

            <h5 class="fw-bold mt-4"><i class="fa-solid fa-building-shield me-2 text-primary"></i>1. Responsable del Tratamiento</h5>
            <p class="text-justify text-muted">
                <strong>Aseguradora App S.L.</strong>, con domicilio en Calle Mayor 123, Madrid, Espa√±a, es la responsable del tratamiento de sus datos personales. Puede contactar con nuestro Delegado de Protecci√≥n de Datos (DPO) en <strong>dpo@aseguradora.com</strong>.
            </p>

            <h5 class="fw-bold mt-4"><i class="fa-solid fa-file-contract me-2 text-primary"></i>2. Finalidad del Tratamiento</h5>
            <p class="text-justify text-muted">
                Sus datos personales ser√°n utilizados exclusivamente para las siguientes finalidades:
                <ul class="text-muted">
                    <li>Gesti√≥n y administraci√≥n de las p√≥lizas de seguro contratadas.</li>
                    <li>Emisi√≥n de facturas y gesti√≥n de cobros.</li>
                    <li>Gesti√≥n de siniestros y asistencia t√©cnica.</li>
                    <li>Env√≠o de comunicaciones relacionadas con el servicio (renovaciones, avisos importantes).</li>
                </ul>
            </p>

            <h5 class="fw-bold mt-4"><i class="fa-solid fa-scale-balanced me-2 text-primary"></i>3. Legitimaci√≥n</h5>
            <p class="text-justify text-muted">
                La base legal para el tratamiento de sus datos es la <strong>ejecuci√≥n del contrato</strong> de seguro del que usted es parte.
            </p>

            <h5 class="fw-bold mt-4"><i class="fa-solid fa-user-lock me-2 text-primary"></i>4. Destinatarios</h5>
            <p class="text-justify text-muted">
                Sus datos no ser√°n cedidos a terceros, salvo obligaci√≥n legal (Agencia Tributaria, Jueces y Tribunales) o proveedores de servicios necesarios para la prestaci√≥n del servicio (servicios de hosting, pasarelas de pago), siempre bajo estrictos contratos de confidencialidad.
            </p>

            <h5 class="fw-bold mt-4"><i class="fa-solid fa-hand-holding-heart me-2 text-primary"></i>5. Derechos del Usuario (ARCO)</h5>
            <p class="text-justify text-muted">
                Como titular de los datos, usted tiene derecho a:
                <ul class="text-muted">
                    <li><strong>Acceder</strong> a sus datos personales.</li>
                    <li>Solicitar la <strong>rectificaci√≥n</strong> de los datos inexactos.</li>
                    <li>Solicitar su <strong>supresi√≥n</strong> cuando, entre otros motivos, los datos ya no sean necesarios para los fines que fueron recogidos.</li>
                    <li>Oponerse al tratamiento de sus datos.</li>
                </ul>
                Puede ejercer estos derechos enviando una solicitud por escrito a nuestra direcci√≥n de contacto.
            </p>

            <hr class="my-5">

            <div class="text-center text-muted small">
                <p class="mb-1"><strong>&copy; ${year} Aseguradora App S.L.</strong> Todos los derechos reservados.</p>
                <p>Inscrita en el Registro Mercantil de Madrid, Tomo 1234, Folio 56, Hoja M-12345.</p>
                <div class="mt-3">
                    <a href="#" class="text-decoration-none me-3">T√©rminos de Uso</a> |
                    <a href="#" class="text-decoration-none mx-3">Pol√≠tica de Cookies</a> | 
                    <a href="#" class="text-decoration-none ms-3">Aviso Legal</a>
                </div>
            </div>
        </div>
    </div>`;
}

// =========================================================
// 5. FUNCIONES DE SISTEMA (BORRAR, IMPRIMIR, CREAR)
// =========================================================

// =========================================================
// 7. L√ìGICA DE BORRADO V2 (Renombrada para evitar cach√©)
// =========================================================
let modalBorrado;      
// Nombres nuevos para evitar conflictos
var borrado_V2_Tipo = "";
var borrado_V2_Id = 0;

// A. Funci√≥n llamada al hacer clic en la papelera
function solicitarBorrado_V2(tipoTexto, idNumero) {
    console.log("--> FASE 1: Click recibido V2. Tipo:", tipoTexto, "ID:", idNumero);

    // Validaci√≥n inmediata
    if (!tipoTexto || !idNumero || idNumero === 0) {
        alert("Error: Datos incorrectos (ID es 0 o Tipo vac√≠o).");
        return;
    }

    // Guardamos en las variables NUEVAS
    borrado_V2_Tipo = tipoTexto;
    borrado_V2_Id = idNumero;
    
    // Abrimos el modal
    if (!modalBorrado) modalBorrado = new bootstrap.Modal(document.getElementById('modalBorrado'));
    
    // Reseteamos el input
    const input = document.getElementById('inputBorradoConfirm');
    const btn = document.getElementById('btnBorrarFinal');
    
    if(input) {
        input.value = "";
        setTimeout(() => input.focus(), 500);
    }
    if(btn) btn.disabled = true;
    
    modalBorrado.show();
}

// B. Verificar texto
function verificarTextoBorrado_V2() {
    const texto = document.getElementById('inputBorradoConfirm').value;
    const btn = document.getElementById('btnBorrarFinal');
    if(btn) btn.disabled = (texto !== "ELIMINAR");
}

// C. Ejecutar el borrado real
async function ejecutarBorrado_V2() {
    // Recuperamos de las variables NUEVAS
    const tipo = borrado_V2_Tipo;
    const id = borrado_V2_Id;
    
    console.log("--> FASE 2: Ejecutando borrado V2 para:", tipo, id);

    // ESCUDO DE SEGURIDAD
    if (!tipo || id === 0) {
        alert("¬°ALTO! Las variables se han perdido. Intenta recargar la p√°gina (F5).");
        if(modalBorrado) modalBorrado.hide();
        return;
    }

    const urlBorrado = API_URL + "/" + tipo + "/" + id;
    const btn = document.getElementById('btnBorrarFinal');
    if(btn) btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const res = await fetch(urlBorrado, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (res.ok) {
            if(modalBorrado) modalBorrado.hide();
            mostrarPopup("Registro eliminado correctamente.");
            cargarSeccion(tipo); 
        } else {
            const texto = await res.text();
            alert("Error del servidor: " + texto);
        }
    } catch (error) {
        alert("Error de conexi√≥n: " + error.message);
    } finally {
        if(btn) btn.innerHTML = 'Confirmar Eliminaci√≥n';
        if(modalBorrado) modalBorrado.hide();
    }
}
// NUEVA FUNCI√ìN: CREAR USUARIO DESDE MODAL
async function crearUsuarioNuevo(e) {
    e.preventDefault();
    const nombre = document.getElementById('newUserName').value;
    const correo = document.getElementById('newUserEmail').value;
    const password = document.getElementById('newUserPass').value;
    const rol = document.getElementById('newUserRol').value;

    const nuevoUsuario = { nombreCompleto: nombre, correo, password, rol, activo: true };

    try {
        const res = await fetch(`${API_URL}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(nuevoUsuario)
        });

        if(res.ok) {
            modalCrearUser.hide();
            mostrarPopup("Usuario creado con √©xito.");
            document.getElementById('formCrearUsuario').reset();
            cargarSeccion('usuarios'); 
        } else {
            const txt = await res.text();
            mostrarPopup("Error al crear usuario: " + txt);
        }
    } catch(err) {
        mostrarPopup("Error de conexi√≥n.");
    }
}

// --- FUNCI√ìN 1: MODIFICADA PARA MOSTRAR BOTONES DE PDF ---
function prepararFactura(factura) {
    const contenidoFactura = `
        <div id="facturaImprimible" class="p-5 bg-white border">
            <div class="d-flex justify-content-between mb-4">
                <div>
                    <h2 class="fw-bold text-primary">FACTURA</h2>
                    <p class="text-muted mb-0">Aseguradora App S.L.</p>
                </div>
                <div class="text-end">
                    <h5 class="text-dark">Ref: INV-${factura.idFactura}</h5>
                    <p class="text-muted">${factura.fechaEmision}</p>
                </div>
            </div>
            <hr>
            <div class="row mb-5">
                <div class="col-6">
                    <h6 class="fw-bold">Cliente:</h6>
                    <p class="mb-0">${usuario.nombreCompleto}</p>
                    <p class="mb-0">${usuario.correo}</p>
                </div>
            </div>
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr><th>Concepto</th><th class="text-end">Importe</th></tr>
                </thead>
                <tbody>
                    <tr><td class="p-3">${factura.concepto}</td><td class="text-end p-3 fw-bold">${factura.importe} ‚Ç¨</td></tr>
                </tbody>
                <tfoot>
                    <tr class="table-secondary"><th class="text-end">TOTAL</th><th class="text-end fs-4">${factura.importe} ‚Ç¨</th></tr>
                </tfoot>
            </table>
        </div>`;
    document.getElementById('areaImpresion').innerHTML = contenidoFactura;

    const footerModal = document.getElementById('printModal').querySelector('.modal-footer');
    footerModal.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" onclick="window.print()"><i class="fa-solid fa-print"></i> Imprimir</button>
        <button type="button" class="btn btn-success" onclick="descargarPDF(${factura.idFactura})"><i class="fa-solid fa-file-pdf"></i> Descargar PDF</button>
    `;
    modalPrint.show();
}

function descargarPDF(id) {
    const elemento = document.getElementById('facturaImprimible');
    if (!elemento || typeof html2pdf === 'undefined') {
        alert("Error: Librer√≠a PDF no cargada.");
        return;
    }
    const opciones = {
        margin:       10,
        filename:     `Factura_${id}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opciones).from(elemento).save();
}
// =========================================================
// 6. L√ìGICA 2FA (SETUP Y CONFIRMACI√ìN)
// =========================================================
let modal2FA; // Variable global para controlar la ventana

async function iniciarSetup2FA() {
    // Inicializar el modal de Bootstrap si no existe a√∫n
    if (!modal2FA) modal2FA = new bootstrap.Modal(document.getElementById('modal2FA'));
    
    try {
        // 1. Pedir al servidor que genere un secreto y la URL del QR
        const res = await fetch(`${API_URL}/auth/setup-2fa`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ correo: usuario.correo })
        });

        if (res.ok) {
            const data = await res.json();
            
            // 2. Limpiar el contenedor del QR anterior (si hab√≠a)
            document.getElementById('qrContainer').innerHTML = ""; 
            
            // 3. Dibujar el nuevo QR usando la librer√≠a que pusimos en el HTML
            new QRCode(document.getElementById("qrContainer"), {
                text: data.qrUrl,
                width: 150,
                height: 150
            });
            
            // 4. Mostrar la ventana
            modal2FA.show();
        } else {
            mostrarPopup("Error al iniciar configuraci√≥n 2FA");
        }
    } catch (e) {
        console.error(e);
        mostrarPopup("Error de conexi√≥n");
    }
}

async function confirmarActivacion2FA() {
    // Leemos el c√≥digo que ha escrito el usuario
    const codigo = document.getElementById('inputCodeConfirm').value;
    
    if (codigo.length !== 6) {
        alert("El c√≥digo debe tener 6 d√≠gitos");
        return;
    }

    try {
        // Enviamos el c√≥digo al servidor para confirmar
        const res = await fetch(`${API_URL}/auth/confirm-2fa`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ correo: usuario.correo, codigo: codigo })
        });

        if (res.ok) {
            modal2FA.hide(); // Cerramos ventana
            mostrarPopup("¬°√âxito! 2FA Activado correctamente.");
            
            // Actualizamos la memoria del navegador para saber que ya est√° activado
            usuario.twoFactorEnabled = true;
            sessionStorage.setItem('usuario', JSON.stringify(usuario));
            
            // Recargamos la secci√≥n para que se vea el bot√≥n verde
            renderizarConfiguracion(document.getElementById('contenido-dinamico'));
        } else {
            alert("C√≥digo incorrecto. Int√©ntalo de nuevo.");
        }
    } catch (e) {
        mostrarPopup("Error al confirmar.");
    }
}
async function desactivar2FA() {
    // Pedimos confirmaci√≥n para evitar clics accidentales
    if (!confirm("¬øSeguro que quieres eliminar la protecci√≥n de doble factor? Tu cuenta ser√° menos segura.")) {
        return;
    }

    try {
        const res = await fetch(`${API_URL}/auth/disable-2fa`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ correo: usuario.correo })
        });

        if (res.ok) {
            mostrarPopup("Has desactivado la autenticaci√≥n en dos pasos.");
            
            // Actualizamos la memoria del navegador
            usuario.twoFactorEnabled = false;
            sessionStorage.setItem('usuario', JSON.stringify(usuario));
            
            // Recargamos la pantalla para ver el bot√≥n azul de nuevo
            renderizarConfiguracion(document.getElementById('contenido-dinamico'));
        } else {
            mostrarPopup("Error al desactivar.");
        }
    } catch (e) {
        console.error(e);
        mostrarPopup("Error de conexi√≥n.");
    }
}

function renderizarCargando(c, t) { c.innerHTML = `<div class="text-center mt-5"><div class="spinner-border text-primary"></div><p>${t}</p></div>`; }
function mostrarError(c) { c.innerHTML = '<div class="alert alert-danger">Error de conexi√≥n con el servidor.</div>'; }
function mostrarPopup(msg) { document.getElementById('modalMensaje').textContent = msg; modalInfo.show(); }
function logout() { sessionStorage.removeItem('usuario'); window.location.href = 'index.html'; }
--- styles.css ---
/* Layout Global */
body {
    padding-top: 60px; /* Espacio para Header */
    background-color: #f8f9fa;
}

/* Header Fijo */
.navbar-top {
    height: 60px;
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1030;
    background-color: #0d6efd; /* Azul Bootstrap */
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.logo-circle {
    width: 40px; height: 40px;
    background: white;
    color: #0d6efd;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold;
    margin-right: 10px;
}

/* Sidebar Fijo */
.sidebar {
    position: fixed;
    top: 60px; bottom: 0; left: 0;
    width: 260px;
    background-color: white;
    border-right: 1px solid #dee2e6;
    padding: 20px 10px;
    overflow-y: auto;
}

/* Contenido Principal */
.main-content {
    margin-left: 260px; /* Deja sitio al sidebar */
    padding: 30px;
}

/* Enlaces */
.nav-link {
    color: #495057;
    margin-bottom: 5px;
    border-radius: 5px;
    padding: 10px 15px;
}
.nav-link:hover {
    background-color: #e9ecef;
}
.nav-link.active {
    background-color: #e7f1ff;
    color: #0d6efd;
    font-weight: bold;
}

.user-badge {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    font-size: 0.9rem;
    color: #333;
    font-weight: bold;
}
/* Ajustes para textos legales */
.text-justify {
    text-align: justify;
}

/* Ajustes tarjetas configuraci√≥n */
.card-header {
    border-bottom: 1px solid #f0f0f0;
}

/* Iconos en formularios */
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
--- End of Listing ---
